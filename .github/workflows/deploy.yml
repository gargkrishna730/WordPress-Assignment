name: WordPress Deployment

on:
  push:
    branches: [ master ]
    paths:
      - 'wordpress-project/**'
      - 'config/nginx/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ master ]
    paths:
      - 'wordpress-project/**'
      - 'config/nginx/**'
  schedule:
    - cron: '0 0 * * 0'  # Run weekly for security scanning

jobs:
  analyze:
    name: Code Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: phpcs, php-cs-fixer, phpmd

      - name: PHP Lint
        run: |
          find wordpress-project -name "*.php" -exec php -l {} \;

      - name: PHP Mess Detector
        run: |
          phpmd wordpress-project text cleancode,codesize,controversial,design,naming,unusedcode

      - name: Check WordPress Coding Standards
        run: |
          phpcs --standard=WordPress wordpress-project

  deploy:
    needs: analyze
    runs-on: self-hosted
    if: success()
    steps:
      - uses: actions/checkout@v2
        with:
          path: repo

      - name: Deploy Changes
        run: |
          # Copy theme and plugin changes
          sudo rsync -av --exclude='wp-config.php' \
              --exclude='wp-content/uploads' \
              --exclude='.git' \
              repo/wordpress-project/wp-content/themes/ /var/www/wordpress/wp-content/themes/
          
          sudo rsync -av --exclude='.git' \
              repo/wordpress-project/wp-content/plugins/ /var/www/wordpress/wp-content/plugins/

          # Update NGINX configuration if changed
          if ! cmp -s repo/config/nginx/wordpress.conf /etc/nginx/sites-available/wordpress; then
            sudo cp repo/config/nginx/wordpress.conf /etc/nginx/sites-available/wordpress
            sudo nginx -t && sudo systemctl restart nginx
          fi

          # Set correct permissions
          sudo chown -R www-data:www-data /var/www/wordpress
          sudo find /var/www/wordpress/ -type d -exec chmod 755 {} \;
          sudo find /var/www/wordpress/ -type f -exec chmod 644 {} \;

          # Clean up
          rm -rf repo

  security-scan:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: WordPress Security Scan
        uses: wpscanteam/wpscan-action@master
        with:
          url: https://wordpressassignment.convertcurrency.online
          random_user_agent: true
          format: json
          output: wpscan-report.json

      - name: OWASP ZAP Scan
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: 'https://wordpressassignment.convertcurrency.online'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'

      - name: Upload scan results
        uses: actions/upload-artifact@v2
        with:
          name: security-scan-results
          path: |
            wpscan-report.json
            zap-baseline-report.html 